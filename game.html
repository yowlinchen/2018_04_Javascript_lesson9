<!DOCTYPE html>
<html lang="en">

<head>
    <title>Sound Effects</title>
    <script>
        // Put all the global variables in ga
        var ga = {
            ctx:null,audio: null,
            res: {
                total:4, loaded:0,
                sounds: {
                    bullet: "./sound-bullet.mp3",
                    explosion: "./sound-explosion.mp3"
                },
                imgs: {
                    plane: "./plane.png",
                    explosion: "./particle-explosion.png"
                }
            }
        };
        window.addEventListener("load", function () {
            // init website
            ga.ctx =document.querySelector("#cvs").getContext("2d");
            // init sound env
            ga.audio = new AudioContext();
            // load resources
            ga.loadResources();
        });
        ga.loadResources = function () {
            ga.loadSounds();
            ga.loadImages();
            // we need to make sure all the resources are successfully loaded.  Only then we can proceed
            if (ga.res.loaded>=ga.res.total) {
                ga.initMenu();
            }
        };
        
        ga.initMenu=function() {
            // HTML DOM
            document.querySelector("#loading").style.display="none";
            document.querySelector("#menu").style.display="block";
            document.querySelector("#game").style.display="none";
        };

        ga.loadImages = function () {
            for (var name in ga.res.imgs) {
                ga.loadImage(name, ga.res.imgs[name]);
            }
        };
        ga.loadImage = function (name, src) {
            var img = new Image();
            img.src = src;
            img.onload = function () {
                ga.res.imgs[name] = img;
                // console.log("Image", name); // THis is the place where images are succesfully loaded
                ga.resourceLoaded();
            };
        };
        ga.loadSounds = function () {
            for (var name in ga.res.sounds) {
                ga.loadSound(name, ga.res.sounds[name]);
            }
        };

        // var snare;
        ga.loadSound = function (name, src) {
            var req = new XMLHttpRequest();
            req.responseType = "arraybuffer";
            req.open("get", src);
            req.onload = function () {
                // console.log(req.response);
                // Transfer ArrayBuffer to AudioBuffer and save it
                ga.audio.decodeAudioData(req.response, function (buffer) {
                    ga.res.sounds[name] = buffer;
                    // console.log(snare);
                    // console.log("Sound", name);
                    ga.resourceLoaded();
                });
            };
            req.send();
        };

        ga.resourceLoaded = function() {
           ga.res.loaded++; 
           var percentage = 100* (ga.res.loaded/ga.res.total);
        //    console.log(percentage);
            document.querySelector("#loading").innerHTML=percentage+"%"
        };

        ga.playSound = function (buffer, time) {
            var source = ga.audio.createBufferSource();
            source.buffer = buffer; // where source is coming from
            // Create gainnode
            // var gain = audio.createGain();
            // connect & play
            // source.connect(gain);
            source.connect(ga.audio.destination); // next box
            source.start(time); // play
        };
        ga.initGame=function() {

        }
    </script>
</head>

<body>
    <div id="loading">Loading</div>
    <div id="menu" style="display:none">Menu
        <button onclick="ga.initGame();">Start</button>
    </div>
    <div id="game" style="display:none">Game
        <canvas id="cvs" width="640" height="480"></canvas>
    </div>
</body>

</html>